{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.1",
    "parameters": {
        "ADadminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the Administrator account of the Domain"
            },
            "ADadminUserName": {
                "defaultValue": "Administrator",
                "metadata": {
                    "description": "The name of the Administrator account of the Domain"
                },
                "type": "string"
            },
            "LocaladminUsername": {
                "defaultValue": "Localadmin",
                "metadata": {
                    "description": "The name of the Administrator of the new VM and Domain"
                },
                "type": "string"

            },
            "LocaladminPassword": {
                "type": "securestring",
                "metadata": {
                    "description": "The password for the Local Administrator of the VMs"
                }

            },

            "DCNicIPAddress": {
                "type": "string",
                "metadata": {
                    "description": "The IP address of the new AD VM"
                },
                "defaultValue": "10.0.0.4"
            },
            "DCNicName": {
                "type": "string",
                "metadata": {
                    "description": "The name of the NIC attached to the new VM"
                },
                "defaultValue": "adNic"
            },
            "PSDemoSubnet": {
                "type": "string",
                "metadata": {
                    "description": "The address range of the subnet created in the new VNET"
                },
                "defaultValue": "10.0.0.0/24"
            },
            "PSDemoSubnetName": {
                "type": "string",
                "metadata": {
                    "description": "The name of the subnet created in the new VNET"
                },
                "defaultValue": "PSDemoSubnet"
            },
            "DCVMName": {
                "type": "string",
                "metadata": {
                    "description": "The name of the VM created"
                },
                "defaultValue": "2012R2-DC"
            },
            "adVMSize": {
                "type": "string",
                "allowedValues": [
                    "Standard_D1",
                    "Standard_DS1",
                    "Standard_D2",
                    "Standard_DS2",
                    "Standard_D3",
                    "Standard_DS3",
                    "Standard_D4",
                    "Standard_DS4",
                    "Standard_D11",
                    "Standard_DS11",
                    "Standard_D12",
                    "Standard_DS12",
                    "Standard_D13",
                    "Standard_DS13",
                    "Standard_D14",
                    "Standard_DS14"
                ],
                "metadata": {
                    "description": "The size of the VM Created"
                },
                "defaultValue": "Standard_D1"
            },
            "assetLocation": {
                "defaultValue": "https://raw.githubusercontent.com/rcarboneras/Psdemotraining/master/active-directory-new-domain-with-data/",
                "metadata": {
                    "description": "The location of resources such as templates and DSC modules that the script is dependent"
                },
                "type": "string"
            },
            "domainName": {
                "type": "string",
                "metadata": {
                    "description": "The FQDN of the AD Domain created ",
                    "defaultValue": "contoso.com"
                }
            },
            "imageOffer": {
                "type": "string",
                "defaultValue": "WindowsServer",
                "metadata": {
                    "description": "Image Offer"
                }
            },
            "imagePublisher": {
                "type": "string",
                "defaultValue": "MicrosoftWindowsServer",
                "metadata": {
                    "description": "Image Publisher"
                }
            },
            "imageSKU": {
                "type": "string",
                "defaultValue": "2012-R2-Datacenter",
                "metadata": {
                    "description": "Image SKU"
                }
            },
            "location": {
                "type": "string",
                "allowedValues": [
                    "West US",
                    "East US",
                    "West Europe",
                    "East Asia",
                    "Southeast Asia"
                ],
                "metadata": {
                    "description": "The region to deploy the resources into"
                },
                "defaultValue": "West Europe"
            },
            "newStorageAccountName": {
                "type": "string",
                "metadata": {
                    "description": "The name of the new storage account created to store the VMs disks"
                }
            },
            "DCpublicIPAddressName": {
                "defaultValue": "adpublicIP",
                "metadata": {
                    "description": "The name of the public IP address used by the DC"
                },
                "type": "string"
            },
            "publicIPAddressType": {
                "type": "string",
                "allowedValues": [
                    "Dynamic",
                    "Static"
                ],
                "metadata": {
                    "description": "The type of the public IP address used by the Load Balancer"
                },
                "defaultValue": "Dynamic"
            },
            "RDPPort": {
                "type": "int",
                "metadata": {
                    "description": "The public RDP port for the VM"
                },
                "defaultValue": 3389
            },
            "storageAccountType": {
                "type": "string",
                "allowedValues": [
                    "Standard_LRS",
                    "Standard_GRS",
                    "Standard_RAGRS",
                    "Standard_ZRS",
                    "Premium_LRS"
                ],
                "metadata": {
                    "description": "The type of the Storage Account created"
                },
                "defaultValue": "Standard_LRS"
            },
            "virtualNetworkAddressRange": {
                "type": "string",
                "metadata": {
                    "description": "The address range of the new VNET in CIDR format"
                },
                "defaultValue": "10.0.0.0/16"
            },
            "virtualNetworkName": {
                "type": "string",
                "metadata": {
                    "description": "The name of the Virtual Network to Create"
                },
                "defaultValue": "adVNET"
            }
        },
        "resources": [
            {
                "type": "Microsoft.Storage/storageAccounts",
                "apiVersion": "2015-05-01-preview",
                "location": "[parameters('location')]",
                "name": "[parameters('newStorageAccountName')]",
                "properties": {
                    "accountType": "[parameters('storageAccountType')]"
                }
            },
            {
                "type": "Microsoft.Network/publicIPAddresses",
                "apiVersion": "2015-05-01-preview",
                "name": "[parameters('DCpublicIPAddressName')]",
                "location": "[parameters('location')]",
                "properties": {
                    "publicIPAllocationMethod": "[parameters('publicIPAddressType')]"
                }
            },
            {
                "type": "Microsoft.Resources/deployments",
                "apiVersion": "2015-01-01",
                "name": "VNet",
                "properties": {
                    "mode": "Incremental",
                    "parameters": {
                        "location": {
                            "value": "[parameters('location')]"
                        },
                        "virtualNetworkName": {
                            "value": "[parameters('virtualNetworkName')]"
                        },
                        "virtualNetworkAddressRange": {
                            "value": "[parameters('virtualNetworkAddressRange')]"
                        },
                        "subnetName": {
                            "value": "[parameters('PSDemoSubnetName')]"
                        },
                        "subnetRange": {
                            "value": "[parameters('PSDemoSubnet')]"
                        }
                    },
                    "templateLink": {
                        "uri": "[variables('vnetTemplateUri')]",
                        "contentVersion": "1.0.0.0"
                    }
                }
            },


            {
                "apiVersion": "2015-05-01-preview",
                "location": "[parameters('location')]",
                "name": "[parameters('DCNicName')]",
                "properties": {
                    "ipConfigurations": [
                        {
                            "name": "ipconfig1",
                            "properties": {
                                "privateIPAllocationMethod": "Static",
                                "privateIPAddress": "[parameters('DCNicIPAddress')]",
                                "subnet": {
                                    "id": "[variables('PSDemoSubnetRef')]"
                                }
                            }
                        }
                    ]
                },
                "type": "Microsoft.Network/networkInterfaces",
                "dependsOn": [
                    "Microsoft.Resources/deployments/VNet"
                ]
            },
            {
                "apiVersion": "2015-05-01-preview",
                "type": "Microsoft.Compute/virtualMachines",
                "name": "[parameters('DCVMName')]",
                "location": "[parameters('location')]",
                "dependsOn": [
                    "[resourceId('Microsoft.Storage/storageAccounts',parameters('newStorageAccountName'))]",
                    "[resourceId('Microsoft.Network/networkInterfaces',parameters('DCNicName'))]",
                ],
                "properties": {
                    "hardwareProfile": {
                        "vmSize": "[parameters('adVMSize')]"
                    },
                    "osProfile": {
                        "computerName": "[parameters('DCVMName')]",
                        "adminUserName": "[parameters('LocaladminUserName')]",
                        "adminPassword": "[parameters('LocaladminPassword')]"
                    },
                    "storageProfile": {
                        "imageReference": {
                            "publisher": "[parameters('imagePublisher')]",
                            "offer": "[parameters('imageOffer')]",
                            "sku": "[parameters('imageSKU')]",
                            "version": "latest"
                        },
                        "osDisk": {
                            "name": "osdisk",
                            "vhd": {
                                "uri": "[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/vhds/','osdisk.vhd')]"
                            },
                            "caching": "ReadWrite",
                            "createOption": "FromImage"
                        },
                        "dataDisks": [
                            {
                                "vhd": {
                                    "uri": "[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/vhds/', variables('adDataDisk'),'-1.vhd')]"
                                },
                                "name": "[concat(parameters('DCVMName'),'-data-disk1')]",
                                "caching": "None",
                                "createOption": "empty",
                                "diskSizeGB": "[variables('adDataDiskSize')]",
                                "lun": 0
                            }
                        ]
                    },
                    "networkProfile": {
                        "networkInterfaces": [
                            {
                                "id": "[resourceId('Microsoft.Network/networkInterfaces',parameters('DCNicName'))]"
                            }
                        ]
                    }
                },
                "resources": [
                    {
                        "type": "Microsoft.Compute/virtualMachines/extensions",
                        "name": "[concat(parameters('DCVMName'),'/CreateADForest')]",
                        "apiVersion": "2015-05-01-preview",
                        "location": "[parameters('location')]",
                        "dependsOn": [
                            "[resourceId('Microsoft.Compute/virtualMachines', parameters('DCVMName'))]"
                        ],
                        "properties": {
                            "publisher": "Microsoft.Powershell",
                            "type": "DSC",
                            "typeHandlerVersion": "2.25",
                            "autoUpgradeMinorVersion": true,
                            "settings": {
                                "ModulesUrl": "[variables('adModulesURL')]",
                                "ConfigurationFunction": "[variables('adConfigurationFunction')]",
                                "Properties": {
                                    "DomainName": "[parameters('domainName')]",
                                    "AdminCreds": {
                                        "UserName": "[parameters('ADadminUserName')]",
                                        "Password": "PrivateSettingsRef:ADadminPassword"
                                    }
                                }
                            },
                            "protectedSettings": {
                                "Items": {
                                    "ADadminPassword": "[parameters('ADadminPassword')]"
                                },
                                "DataBlobUri": "[concat(parameters('assetLocation'),'CreateADDomainWithData.psd1')]"
                            }
                        }
                    }
                ],           
        
        "variables": {
            "adConfigurationFunction": "CreateADDomainWithData.ps1\\CreateADDomainWithData",
            "adDataDisk": "ADDataDisk",
            "adDataDiskSize": 5,
            "adIPConfigID": "[concat(variables('adNicId'),'/ipConfigurations/ipconfig1')]",
            "adModulesURL": "[concat(parameters('assetLocation'),'CreateADDomainWithData.ps1.zip')]",
            "adNicId": "[resourceId('Microsoft.Network/networkInterfaces',parameters('DCNicName'))]",
            "PSDemoSubnetRef": "[concat(variables('VnetID'),'/subnets/',parameters('PSDemoSubnetName'))]",
            "VnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
            "vnetTemplateUri": "[concat(parameters('assetLocation'),'vnet.json')]",
            "vnetwithDNSTemplateUri": "[concat(parameters('assetLocation'),'vnet-with-dns-server.json')]"
        }
    }
